<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æœˆçµé¤é»è²»ç”¨çµ±è¨ˆ - æ–‡é’é¢¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* è«è˜­è¿ªè‰²ç³» (Morandi Colors) å®šç¾© 
           èƒŒæ™¯: #F2F0EB (æº«æš–ç±³ç°)
           å®¹å™¨: #FFFFFF
           ä¸»è‰²èª¿(ç¶ ): #8FA39D (ç°ç¶  Sage Green)
           ä¸»è‰²èª¿(è—): #7A8B99 (éœ§éœ¾è— Dusty Blue)
           å¼·èª¿è‰²(ç´…): #C76C6C (ä¹¾ç‡¥ç«ç‘°/ç£šç´… Muted Coral)
           è¼”åŠ©è‰²(ç±³): #E8E6E1
           æ–‡å­—: #333333 (åŠ æ·± - æ·±é»‘ç°)
        */

        body { 
            font-family: "Microsoft JhengHei", "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: #F2F0EB; 
            color: #333; 
            margin: 0; 
            padding: 20px; 
            letter-spacing: 0.05em; 
        }
        
        .container { 
            /* æ•´é«”ç•«é¢ç¸½å¯¬åº¦é…åˆèª¿æ•´ï¼Œç”± 800px å¢åŠ è‡³ 1000px */
            max-width: 1000px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); 
        }
        
        h1 { 
            text-align: center; 
            color: #455A64; 
            font-weight: normal;
            margin-bottom: 30px;
        }
        
        .control-panel { 
            display: flex; 
            gap: 20px; 
            background: #E8E6E1; 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 25px; 
            align-items: center; 
            color: #444; 
        }
        
        select, input[type="file"] {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #CCC;
            background: #FAFAFA;
            color: #333; 
        }

        /* èª¿æ•´äººå“¡è²»ç”¨ç¸½è¡¨æ¯”ä¾‹ï¼Œä½¿å…¶æ›´å¯¬ä¸€é» (1.2fr : 2fr) */
        .main-content { display: grid; grid-template-columns: 1.2fr 2fr; gap: 25px; }
        
        .section { 
            border: 1px solid #EBEBEB; 
            border-radius: 8px; 
            padding: 20px; 
            min-height: 550px; 
            background: #fff; 
            display: flex; 
            flex-direction: column;
            box-shadow: 0 4px 10px rgba(0,0,0,0.02);
        }
        
        h3 { 
            margin-top: 0; 
            border-bottom: 2px solid #F0F0F0; 
            padding-bottom: 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            color: #444; 
            font-size: 1.1rem;
            font-weight: 600; 
        }
        
        .scroll-area { 
            flex-grow: 1; 
            overflow-y: auto; 
            border: 1px solid #F5F5F5; 
            border-radius: 4px;
        }
        
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { text-align: left; padding: 12px 15px; border-bottom: 1px solid #F0F0F0; }
        
        #summaryTable th:nth-child(2),
        #summaryTable td:nth-child(2) {
            text-align: right;
        }
        
        th { 
            background-color: #E0E5DF; 
            color: #333; 
            position: sticky; 
            top: 0; 
            z-index: 10; 
            font-weight: 700; 
        }
        
        .total-divider { 
            background-color: #FAF9F6; 
            color: #5D4037; 
            font-weight: bold; 
            border-top: 2px solid #C9BCA5; 
            border-bottom: 2px solid #C9BCA5; 
        }
        
        .excluded-header-row { 
            background-color: #F7F7F7; 
            color: #777; 
            font-size: 13px; 
            text-align: center; 
            font-weight: normal; 
            padding: 8px;
        }
        
        .excluded-row { background-color: #FCFCFC; color: #AAA; }
        
        .name-cell { display: flex; align-items: center; gap: 8px; cursor: pointer; transition: color 0.2s; }
        .name-cell:hover { color: #5E7D75; }
        
        .red-star { color: #C76C6C; font-weight: bold; } 
        
        .btn-group { display: flex; gap: 10px; }
        
        .btn { 
            border: none; 
            padding: 8px 15px; 
            border-radius: 6px; 
            cursor: pointer; 
            color: white; 
            font-size: 13px; 
            display: none; 
            transition: opacity 0.2s, background-color 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn:hover { opacity: 0.9; }
        
        #copyBtn { background-color: #7A918D; } 
        #copyImgBtn { background-color: #6B7C8A; } 
        
        .non-monthly-box { 
            margin-top: 15px; 
            padding: 12px; 
            background: #F4EBEB; 
            border-left: 4px solid #D68C8C; 
            font-size: 14px; 
            color: #666; 
            border-radius: 0 4px 4px 0;
        }
        
        .clickable-date { 
            color: #5D6D7E; 
            text-decoration: underline; 
            cursor: pointer; 
            margin-right: 8px; 
            font-weight: bold; 
        }

        .detail-box { 
            background: #FAFAFA; 
            padding: 20px; 
            border-radius: 6px; 
            border: 1px solid #F0F0F0; 
            flex-grow: 1; 
            overflow-y: auto; 
        }
        
        .detail-row { 
            padding: 10px 0; 
            border-bottom: 1px solid #EEE; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-size: 14px; 
            color: #333; 
        }
        
        .detail-content { flex: 1; padding-right: 15px; line-height: 1.5; }
        
        .price-input { 
            width: 70px; 
            text-align: right; 
            border: 1px solid #DDD; 
            border-radius: 4px; 
            padding: 5px; 
            font-size: 14px;
            font-weight: bold; 
            color: #B05B5B; 
            background: #FFF;
        }
        .price-input:focus { outline: 2px solid #E0E5DF; border-color: #8FA39D; }

        .price-text { display: none; font-weight: bold; color: #B05B5B; font-size: 14px; }

        .capturing .price-input { display: none !important; }
        .capturing .price-text { display: inline !important; }
        .capturing .detail-box { 
            overflow: visible !important; 
            height: auto !important; 
            border: none !important; 
            background: white !important; 
            padding: 5px !important;
        }
        .capturing .detail-row { border-bottom: 1px solid #E0E0E0; padding: 12px 0; }
        .capturing #imgTitle { color: #333; } 
    </style>
</head>
<body>

<div class="container">
    <h1>æœˆçµé¤é»è²»ç”¨çµ±è¨ˆ</h1>
    <div class="control-panel">
        <div>1. ä¸Šå‚³æª”æ¡ˆï¼š<input type="file" id="fileInput" accept=".txt"></div>
        <div>2. é¸æ“‡æœˆä»½ï¼š<select id="monthSelect"></select></div>
    </div>
    <div class="main-content">
        <div class="section">
            <h3>äººå“¡è²»ç”¨ç¸½è¡¨</h3>
            <div class="scroll-area" id="summaryScrollArea">
                <table id="summaryTable">
                    <thead><tr><th style="width:70%">å§“å</th><th style="width:30%">ç¸½é¡</th></tr></thead>
                    <tbody id="includedBody"></tbody>
                    <tbody>
                        <tr class="total-divider">
                            <td>å…¨é«”ç¸½è¨ˆ</td>
                            <td id="grandTotal">0</td>
                        </tr>
                        <tr class="excluded-header-row">
                            <td colspan="2">â–¼ æ’é™¤ä¸è¨ˆå€åŸŸ (ä¸åˆ—å…¥ç¸½é¡)</td>
                        </tr>
                    </tbody>
                    <tbody id="excludedBody" class="excluded-row"></tbody>
                </table>
            </div>
            <div id="nonMonthlyList" class="non-monthly-box" style="display:none;"></div>
        </div>
        <div class="section">
            <h3>
                <div>å€‹äººæ˜ç´°ï¼š<span id="selectedPersonName">-</span></div>
                <div class="btn-group">
                    <button id="copyBtn" class="btn">ğŸ“‹ è¤‡è£½æ–‡å­—</button>
                    <button id="copyImgBtn" class="btn">ğŸ–¼ï¸ è¤‡è£½åœ–ç‰‡</button>
                </div>
            </h3>
            <div id="captureArea" style="background: white; padding: 15px; border-radius: 6px;">
                <h4 id="imgTitle" style="margin: 0 0 15px 0; display:none; border-bottom: 2px solid #8FA39D; padding-bottom: 8px; font-size: 18px; color: #333;"></h4>
                <div id="personalDetail" class="detail-box"></div>
            </div>
        </div>
    </div>
</div>

<script>
    let rawFileText = "";
    let forceIncludeDates = new Set();
    let excludedUsers = new Set();
    let personalStats = {};
    let nonMonthlyDates = [];
    let currentSelectedUser = null; 

    function parseLunchFile(text, targetMonth) {
        const lines = text.split(/\r?\n/);
        const result = {};
        const dateRegex = /^(\d{4}\.\d{2}\.\d{2})/;
        let datePositions = [];
        nonMonthlyDates = [];

        lines.forEach((line, idx) => {
            const m = line.match(dateRegex);
            if (m) datePositions.push({ idx, date: m[1].replace(/\./g, '-') });
        });

        datePositions.forEach((pos, i) => {
            if (!pos.date.startsWith(targetMonth.replace('.','-'))) return;
            const nextIdx = datePositions[i+1] ? datePositions[i+1].idx : lines.length;
            const dayLines = lines.slice(pos.idx, nextIdx);
            if (dayLines.some(l => l.includes("$$æœˆçµ")) || forceIncludeDates.has(pos.date.replace(/-/g, '.'))) {
                let lunchIdx = dayLines.findLastIndex(l => l.trim() === "åˆé¤");
                if (lunchIdx !== -1) result[pos.date] = extractDayData(dayLines.slice(lunchIdx));
            } else {
                nonMonthlyDates.push(pos.date.replace(/-/g, '.'));
            }
        });
        return result;
    }

    function extractDayData(lines) {
        const dayData = {};
        let mode = "meal";
        lines.forEach(line => {
            let t = line.trim();
            if (t === "---" || t.includes("é£²æ–™")) { mode = "drink"; return; }
            if (t === "åˆé¤") { mode = "meal"; return; }
            if (!t || t.includes("$$æœˆçµ") || t.includes("çµå–®")) return;
            const nameMatch = t.match(/^([^\d\s\-:ï¼š]{2,8})\s*[-:ï¼š]{1,2}(.*)$/);
            if (nameMatch) {
                let name = nameMatch[1].trim().replace(/^\$/, ''); 
                if (name === "å°è¨ˆ") return;

                let content = nameMatch[2].trim();
                if (!dayData[name]) dayData[name] = { total: 0, items: [], hasError: false };
                let price = content.includes('=') ? parseInt(content.split('=').pop().match(/\d+/)) : parseInt(content.match(/\d+$/));
                if (isNaN(price)) { 
                    dayData[name].hasError = true; 
                    dayData[name].items.push({ text: "âš ï¸ " + content, price: 0 }); 
                } else { 
                    dayData[name].total += price; 
                    dayData[name].items.push({ text: content, price: price }); 
                }
            }
        });
        return dayData;
    }

    document.getElementById('fileInput').addEventListener('change', e => {
        const reader = new FileReader();
        reader.onload = () => {
            rawFileText = reader.result;
            const matches = rawFileText.match(/\d{4}\.\d{2}\.\d{2}/g);
            if(matches) {
                const months = [...new Set(matches.map(d => d.substring(0, 7)))].sort().reverse();
                document.getElementById('monthSelect').innerHTML = months.map(m => `<option value="${m}">${m}æœˆ</option>`).join('');
                render();
            }
        };
        reader.readAsText(e.target.files[0]);
    });

    document.getElementById('monthSelect').addEventListener('change', render);

    function render() {
        const month = document.getElementById('monthSelect').value;
        const data = parseLunchFile(rawFileText, month);
        personalStats = {};
        for (let date in data) {
            for (let name in data[date]) {
                if (!personalStats[name]) personalStats[name] = { total: 0, details: [], error: false };
                personalStats[name].total += data[date][name].total;
                if (data[date][name].hasError) personalStats[name].error = true;
                
                const items = data[date][name].items;
                if (items.length > 0) {
                    const combinedText = items.map(item => item.text).join('ã€');
                    const dayTotal = data[date][name].total;
                    
                    personalStats[name].details.push({ 
                        date: date, 
                        text: combinedText, 
                        price: dayTotal 
                    });
                }
            }
        }
        buildTable();
        renderNonMonthly();
        if (currentSelectedUser && personalStats[currentSelectedUser]) {
            updateDetail(currentSelectedUser);
        }
    }

    function buildTable() {
        const scrollArea = document.getElementById('summaryScrollArea');
        const currentScroll = scrollArea.scrollTop;
        const incBody = document.getElementById('includedBody');
        const excBody = document.getElementById('excludedBody');

        incBody.innerHTML = ''; excBody.innerHTML = '';

        let grandTotal = 0;
        Object.keys(personalStats).sort().forEach(name => {
            const isExc = excludedUsers.has(name);
            const stats = personalStats[name];
            if (!isExc) grandTotal += stats.total;

            const tr = document.createElement('tr');
            if (isExc) tr.className = 'excluded-row';
            tr.innerHTML = `
                <td>
                    <div class="name-cell">
                        <input type="checkbox" ${isExc ? '' : 'checked'} onchange="toggleUser('${name}')">
                        <span onclick="selectUser('${name}')">${name}${stats.error ? '<span class="red-star">*</span>' : ''}</span>
                    </div>
                </td>
                <td onclick="selectUser('${name}')" id="sum-${name}">${stats.total.toLocaleString()}</td>
            `;
            if (isExc) excBody.appendChild(tr); else incBody.appendChild(tr);
        });

        document.getElementById('grandTotal').textContent = grandTotal.toLocaleString();
        requestAnimationFrame(() => { scrollArea.scrollTop = currentScroll; });
    }

    function toggleUser(name) {
        if (excludedUsers.has(name)) excludedUsers.delete(name);
        else excludedUsers.add(name);
        buildTable();
    }

    function selectUser(name) {
        currentSelectedUser = name; 
        updateDetail(name);
    }

    function handlePriceChange(name, detailIndex, newPrice, inputEl) {
        const val = parseInt(newPrice) || 0;
        personalStats[name].details[detailIndex].price = val;
        
        inputEl.nextElementSibling.textContent = val.toLocaleString();

        const newTotal = personalStats[name].details.reduce((sum, d) => sum + d.price, 0);
        personalStats[name].total = newTotal;
        document.getElementById(`detail-total-${name}`).textContent = newTotal.toLocaleString();
        document.getElementById(`sum-${name}`).textContent = newTotal.toLocaleString();
        
        let grand = 0;
        Object.keys(personalStats).forEach(n => { if (!excludedUsers.has(n)) grand += personalStats[n].total; });
        document.getElementById('grandTotal').textContent = grand.toLocaleString();
    }

    function updateDetail(name) {
        const stats = personalStats[name];
        if(!stats) return;
        document.getElementById('selectedPersonName').innerHTML = name + (stats.error ? '<span class="red-star">*</span>' : '');
        document.getElementById('imgTitle').innerHTML = `ã€${name}${stats.error ? '<span style="color:#C76C6C">*</span>' : ''} é¤è²»æ˜ç´°ã€‘`;
        document.getElementById('copyBtn').style.display = document.getElementById('copyImgBtn').style.display = 'inline-block';
        
        const box = document.getElementById('personalDetail');
        stats.details.sort((a,b)=>a.date.localeCompare(b.date));
        
        box.innerHTML = stats.details.map((d, index) => `
            <div class="detail-row">
                <span class="detail-content">${d.date.substring(5).replace('-','/')}ï¼š${d.text}</span>
                <input type="number" class="price-input" value="${d.price}" oninput="handlePriceChange('${name}', ${index}, this.value, this)">
                <span class="price-text">${d.price.toLocaleString()}</span>
            </div>
        `).join('') + `<hr style="border:0; border-top:1px dashed #CCC;"><div style="text-align:right; font-weight:bold; padding-top:10px; font-size:16px; color:#555;">ç¸½è¨ˆï¼š<span id="detail-total-${name}" style="color:#B05B5B">${stats.total.toLocaleString()}</span> å…ƒ</div>`;
    }

    function renderNonMonthly() {
        const el = document.getElementById('nonMonthlyList');
        if (nonMonthlyDates.length > 0) {
            el.style.display = 'block';
            el.innerHTML = `<strong>éæœˆçµæ—¥æœŸï¼ˆé»æ“Šå¯åŠ å…¥ï¼‰ï¼š</strong><br>`;
            nonMonthlyDates.forEach(date => {
                const span = document.createElement('span');
                span.className = 'clickable-date';
                span.textContent = date;
                span.onclick = () => { if (confirm(`æ˜¯å¦å°‡æ—¥æœŸ ${date} åŠ å…¥æœˆçµç´¯è¨ˆä¸­ï¼Ÿ`)) { forceIncludeDates.add(date); render(); } };
                el.appendChild(span);
            });
        } else el.style.display = 'none';
    }

    document.getElementById('copyBtn').addEventListener('click', () => {
        const name = currentSelectedUser;
        if (!name) return;
        
        const monthVal = document.getElementById('monthSelect').value; 
        let monthStr = "XX";
        if (monthVal && monthVal.includes('.')) {
            monthStr = parseInt(monthVal.split('.')[1], 10);
        }

        let txt = `${monthStr}æœˆçš„åˆé¤éŒ¢~Line payæˆ–æ˜¯åŒ¯æ¬¾éƒ½å¯å–”\n(ä¸è¦ipass money)\n\nâ†“åŒ¯æ¬¾å¸³è™Ÿâ†“\näº¬åŸéŠ€è¡Œ ç¸½è¡Œç‡Ÿæ¥­éƒ¨\n054\n001280705711`;
        
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(txt)
                .then(() => {
                    showCopyFeedback('copyBtn'); 
                })
                .catch(err => {
                    console.warn("Clipboard API failed, using fallback", err);
                    if(fallbackCopyText(txt)) {
                        showCopyFeedback('copyBtn'); 
                    }
                });
        } else {
            if(fallbackCopyText(txt)) {
                showCopyFeedback('copyBtn'); 
            }
        }
    });

    function showCopyFeedback(btnId, msg = "âœ”ï¸ å·²è¤‡è£½ï¼") {
        const btn = document.getElementById(btnId);
        const originalText = btn.innerHTML; 
        
        btn.innerHTML = msg;
        btn.style.backgroundColor = "#5E7D75"; 
        btn.style.cursor = "default";
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.style.backgroundColor = ""; 
            btn.style.cursor = "pointer";
        }, 2000);
    }

    function fallbackCopyText(text) {
        var textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed"; 
        textArea.style.left = "-9999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        let success = false;
        try {
            success = document.execCommand('copy');
            if(!success) {
                alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚');
            }
        } catch (err) {
            alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚');
        }
        document.body.removeChild(textArea);
        return success;
    }

    document.getElementById('copyImgBtn').addEventListener('click', () => {
        const area = document.getElementById('captureArea');
        const imgTitle = document.getElementById('imgTitle');
        const personName = currentSelectedUser;
        
        imgTitle.style.display = 'block';
        document.body.classList.add('capturing');
        
        setTimeout(() => {
            html2canvas(area, { 
                scale: 2, 
                backgroundColor: "#ffffff" 
            }).then(canvas => {
                canvas.toBlob(blob => {
                    if (navigator.clipboard && navigator.clipboard.write) {
                        const item = new ClipboardItem({ "image/png": blob });
                        navigator.clipboard.write([item]).then(() => {
                            showCopyFeedback('copyImgBtn', 'âœ”ï¸ å·²è¤‡è£½ï¼');
                            resetUI();
                        }).catch(err => {
                            console.warn("Image copy failed, downloading instead", err);
                            downloadImage(canvas, personName);
                            showCopyFeedback('copyImgBtn', 'âœ”ï¸ å·²ä¸‹è¼‰');
                            resetUI();
                        });
                    } else {
                        downloadImage(canvas, personName);
                        showCopyFeedback('copyImgBtn', 'âœ”ï¸ å·²ä¸‹è¼‰');
                        resetUI();
                    }
                });
            }).catch(err => {
                console.error("html2canvas failed", err);
                resetUI();
            });
        }, 150);
        
        function resetUI() {
            imgTitle.style.display = 'none';
            document.body.classList.remove('capturing');
        }
        
        function downloadImage(canvas, name) {
            const link = document.createElement('a');
            link.download = `é¤è²»æ˜ç´°-${name}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }
    });
</script>
</body>
</html>
