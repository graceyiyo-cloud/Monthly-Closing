<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>é¤é»è²»ç”¨çµ±è¨ˆç³»çµ± - æˆªåœ–å„ªåŒ–ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        .control-panel { display: flex; gap: 20px; background: #e9ecef; padding: 20px; border-radius: 6px; margin-bottom: 20px; align-items: center; }
        .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .section { border: 1px solid #ddd; border-radius: 6px; padding: 15px; min-height: 550px; background: #fff; display: flex; flex-direction: column; }
        h3 { margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        
        .scroll-area { flex-grow: 1; overflow-y: auto; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { text-align: left; padding: 10px; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; position: sticky; top: 0; z-index: 10; }
        
        .total-divider { background-color: #fff9e6; font-weight: bold; border-top: 2px solid #ffcc00; border-bottom: 2px solid #ffcc00; }
        .excluded-header-row { background-color: #f0f0f0; color: #777; font-size: 13px; text-align: center; font-weight: bold; }
        .excluded-row { background-color: #fafafa; color: #aaa; }
        
        .name-cell { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .red-star { color: #ff0000; font-weight: bold; }
        .btn-group { display: flex; gap: 8px; }
        .btn { border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; color: white; font-size: 13px; display: none; }
        #copyBtn { background-color: #28a745; }
        #copyImgBtn { background-color: #007bff; }
        
        .non-monthly-box { margin-top: 15px; padding: 10px; background: #fff3f3; border-left: 4px solid #d9534f; font-size: 14px; color: #666; }
        .clickable-date { color: #007bff; text-decoration: underline; cursor: pointer; margin-right: 8px; font-weight: bold; }

        /* æ˜ç´°å€åŸŸæ¨£å¼ */
        .detail-box { background: #fafafa; padding: 15px; border-radius: 4px; border: 1px inset #eee; flex-grow: 1; overflow-y: auto; }
        .detail-row { padding: 8px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 16px; }
        .detail-content { flex: 1; padding-right: 15px; line-height: 1.4; }
        
        /* æ­£å¸¸çš„ç·¨è¼¯æ¡†æ¨£å¼ */
        .price-input { 
            width: 70px; 
            text-align: right; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            padding: 4px; 
            font-size: 16px;
            font-weight: bold; 
            color: #d9534f;
        }

        /* æˆªåœ–æ™‚é¡¯ç¤ºçš„ç´”æ–‡å­—æ¨™ç±¤ (é è¨­éš±è—) */
        .price-text { display: none; font-weight: bold; color: #d9534f; font-size: 16px; }

        /* æˆªåœ–æ¨¡å¼ä¸‹çš„ç‰¹æ®Šè™•ç†ï¼šéš±è— Inputï¼Œé¡¯ç¤ºç´”æ–‡å­— */
        .capturing .price-input { display: none !important; }
        .capturing .price-text { display: inline !important; }
        .capturing .detail-box { overflow: visible !important; height: auto !important; border: none !important; background: white !important; }
        .capturing .detail-row { border-bottom: 1px solid #ddd; padding: 10px 0; }
        
        /* ç‚ºäº†ä¿éšªèµ·è¦‹ï¼ŒåŠ å…¥ Pre æ¨£å¼ä½†ä¸å½±éŸ¿ä¸»é«” */
        pre { background: #f5f5f5; padding: 15px; white-space: pre-wrap; line-height: 1.6; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ± é¤é»è²»ç”¨çµ±è¨ˆç³»çµ±</h1>
    <div class="control-panel">
        <div>1. ä¸Šå‚³æª”æ¡ˆï¼š<input type="file" id="fileInput" accept=".txt"></div>
        <div>2. é¸æ“‡æœˆä»½ï¼š<select id="monthSelect"></select></div>
    </div>
    <div class="main-content">
        <div class="section">
            <h3>äººå“¡è²»ç”¨ç¸½è¡¨</h3>
            <div class="scroll-area" id="summaryScrollArea">
                <table id="summaryTable">
                    <thead><tr><th style="width:70%">å§“å</th><th style="width:30%">ç¸½é¡</th></tr></thead>
                    <tbody id="includedBody"></tbody>
                    <tbody>
                        <tr class="total-divider">
                            <td>å…¨é«”ç¸½è¨ˆ</td>
                            <td id="grandTotal">0</td>
                        </tr>
                        <tr class="excluded-header-row">
                            <td colspan="2">â–¼ æ’é™¤ä¸è¨ˆå€åŸŸ (ä¸åˆ—å…¥ç¸½é¡)</td>
                        </tr>
                    </tbody>
                    <tbody id="excludedBody" class="excluded-row"></tbody>
                </table>
            </div>
            <div id="nonMonthlyList" class="non-monthly-box" style="display:none;"></div>
        </div>
        <div class="section">
            <h3>
                <div>å€‹äººæ˜ç´°ï¼š<span id="selectedPersonName">-</span></div>
                <div class="btn-group">
                    <button id="copyBtn" class="btn">ğŸ“‹ è¤‡è£½æ–‡å­—</button>
                    <button id="copyImgBtn" class="btn">ğŸ–¼ï¸ è¤‡è£½åœ–ç‰‡</button>
                </div>
            </h3>
            <select id="personSelect" style="width: 100%; margin-bottom: 15px;"><option value="">-- é¸æ“‡äººå“¡ --</option></select>
            <div id="captureArea" style="background: white; padding: 15px;">
                <h4 id="imgTitle" style="margin: 0 0 10px 0; display:none; border-bottom: 2px solid #333; padding-bottom: 5px; font-size: 18px;"></h4>
                <div id="personalDetail" class="detail-box"></div>
            </div>
        </div>
    </div>
</div>

<script>
    let rawFileText = "";
    let forceIncludeDates = new Set();
    let excludedUsers = new Set();
    let personalStats = {};
    let nonMonthlyDates = [];

    function parseLunchFile(text, targetMonth) {
        const lines = text.split(/\r?\n/);
        const result = {};
        const dateRegex = /^(\d{4}\.\d{2}\.\d{2})/;
        let datePositions = [];
        nonMonthlyDates = [];

        lines.forEach((line, idx) => {
            const m = line.match(dateRegex);
            if (m) datePositions.push({ idx, date: m[1].replace(/\./g, '-') });
        });

        datePositions.forEach((pos, i) => {
            if (!pos.date.startsWith(targetMonth.replace('.','-'))) return;
            const nextIdx = datePositions[i+1] ? datePositions[i+1].idx : lines.length;
            const dayLines = lines.slice(pos.idx, nextIdx);
            if (dayLines.some(l => l.includes("$$æœˆçµ")) || forceIncludeDates.has(pos.date.replace(/-/g, '.'))) {
                let lunchIdx = dayLines.findLastIndex(l => l.trim() === "åˆé¤");
                if (lunchIdx !== -1) result[pos.date] = extractDayData(dayLines.slice(lunchIdx));
            } else {
                nonMonthlyDates.push(pos.date.replace(/-/g, '.'));
            }
        });
        return result;
    }

    function extractDayData(lines) {
        const dayData = {};
        let mode = "meal";
        lines.forEach(line => {
            let t = line.trim();
            if (t === "---" || t.includes("é£²æ–™")) { mode = "drink"; return; }
            if (t === "åˆé¤") { mode = "meal"; return; }
            if (!t || t.includes("$$æœˆçµ") || t.includes("çµå–®")) return;
            const nameMatch = t.match(/^([^\d\s\-:ï¼š]{2,8})\s*[-:ï¼š]{1,2}(.*)$/);
            if (nameMatch) {
                let name = nameMatch[1].trim().replace(/^\$/, ''); 
                let content = nameMatch[2].trim();
                if (!dayData[name]) dayData[name] = { total: 0, items: [], hasError: false };
                let price = content.includes('=') ? parseInt(content.split('=').pop().match(/\d+/)) : parseInt(content.match(/\d+$/));
                if (isNaN(price)) { 
                    dayData[name].hasError = true; 
                    dayData[name].items.push({ text: "âš ï¸ " + content, price: 0 }); 
                } else { 
                    dayData[name].total += price; 
                    dayData[name].items.push({ text: content, price: price }); 
                }
            }
        });
        return dayData;
    }

    document.getElementById('fileInput').addEventListener('change', e => {
        const reader = new FileReader();
        reader.onload = () => {
            rawFileText = reader.result;
            const matches = rawFileText.match(/\d{4}\.\d{2}\.\d{2}/g);
            if(matches) {
                const months = [...new Set(matches.map(d => d.substring(0, 7)))].sort().reverse();
                document.getElementById('monthSelect').innerHTML = months.map(m => `<option value="${m}">${m}æœˆ</option>`).join('');
                render();
            }
        };
        reader.readAsText(e.target.files[0]);
    });

    document.getElementById('monthSelect').addEventListener('change', render);

    function render() {
        const month = document.getElementById('monthSelect').value;
        const data = parseLunchFile(rawFileText, month);
        personalStats = {};
        for (let date in data) {
            for (let name in data[date]) {
                if (!personalStats[name]) personalStats[name] = { total: 0, details: [], error: false };
                personalStats[name].total += data[date][name].total;
                if (data[date][name].hasError) personalStats[name].error = true;
                data[date][name].items.forEach(item => {
                    personalStats[name].details.push({ date, text: item.text, price: item.price });
                });
            }
        }
        buildTable();
        renderNonMonthly();
    }

    function buildTable() {
        const scrollArea = document.getElementById('summaryScrollArea');
        const currentScroll = scrollArea.scrollTop;
        const incBody = document.getElementById('includedBody');
        const excBody = document.getElementById('excludedBody');
        const pSelect = document.getElementById('personSelect');
        const selVal = pSelect.value;

        incBody.innerHTML = ''; excBody.innerHTML = '';
        pSelect.innerHTML = '<option value="">-- é¸æ“‡äººå“¡ --</option>';

        let grandTotal = 0;
        Object.keys(personalStats).sort().forEach(name => {
            const isExc = excludedUsers.has(name);
            const stats = personalStats[name];
            if (!isExc) grandTotal += stats.total;

            const tr = document.createElement('tr');
            if (isExc) tr.className = 'excluded-row';
            tr.innerHTML = `
                <td>
                    <div class="name-cell">
                        <input type="checkbox" ${isExc ? '' : 'checked'} onchange="toggleUser('${name}')">
                        <span onclick="selectUser('${name}')">${name}${stats.error ? '<span class="red-star">*</span>' : ''}</span>
                    </div>
                </td>
                <td onclick="selectUser('${name}')" id="sum-${name}">${stats.total}</td>
            `;
            if (isExc) excBody.appendChild(tr); else incBody.appendChild(tr);

            const opt = document.createElement('option');
            opt.value = name; opt.textContent = name + (stats.error ? '*' : '');
            pSelect.appendChild(opt);
        });

        document.getElementById('grandTotal').textContent = grandTotal;
        pSelect.value = selVal;
        requestAnimationFrame(() => { scrollArea.scrollTop = currentScroll; });
    }

    function toggleUser(name) {
        if (excludedUsers.has(name)) excludedUsers.delete(name);
        else excludedUsers.add(name);
        buildTable();
    }

    function selectUser(name) {
        document.getElementById('personSelect').value = name;
        updateDetail(name);
    }

    function handlePriceChange(name, detailIndex, newPrice, inputEl) {
        const val = parseInt(newPrice) || 0;
        personalStats[name].details[detailIndex].price = val;
        
        // åŒæ­¥æ›´æ–°éš±è—çš„ç´”æ–‡å­—æ¨™ç±¤å…§å®¹
        inputEl.nextElementSibling.textContent = val;

        const newTotal = personalStats[name].details.reduce((sum, d) => sum + d.price, 0);
        personalStats[name].total = newTotal;
        document.getElementById(`detail-total-${name}`).textContent = newTotal;
        document.getElementById(`sum-${name}`).textContent = newTotal;
        
        let grand = 0;
        Object.keys(personalStats).forEach(n => { if (!excludedUsers.has(n)) grand += personalStats[n].total; });
        document.getElementById('grandTotal').textContent = grand;
    }

    function updateDetail(name) {
        const stats = personalStats[name];
        if(!stats) return;
        document.getElementById('selectedPersonName').innerHTML = name + (stats.error ? '<span class="red-star">*</span>' : '');
        document.getElementById('imgTitle').innerHTML = `ã€${name}${stats.error ? '<span style="color:red">*</span>' : ''} é¤è²»æ˜ç´°ã€‘`;
        document.getElementById('copyBtn').style.display = document.getElementById('copyImgBtn').style.display = 'inline-block';
        
        const box = document.getElementById('personalDetail');
        stats.details.sort((a,b)=>a.date.localeCompare(b.date));
        
        box.innerHTML = stats.details.map((d, index) => `
            <div class="detail-row">
                <span class="detail-content">${d.date.substring(5).replace('-','/')}ï¼š${d.text}</span>
                <input type="number" class="price-input" value="${d.price}" oninput="handlePriceChange('${name}', ${index}, this.value, this)">
                <span class="price-text">${d.price}</span>
            </div>
        `).join('') + `<hr><div style="text-align:right; font-weight:bold; padding-top:10px; font-size:18px;">ç¸½è¨ˆï¼š<span id="detail-total-${name}">${stats.total}</span> å…ƒ</div>`;
    }

    function renderNonMonthly() {
        const el = document.getElementById('nonMonthlyList');
        if (nonMonthlyDates.length > 0) {
            el.style.display = 'block';
            el.innerHTML = `<strong>éæœˆçµæ—¥æœŸï¼ˆé»æ“Šå¯åŠ å…¥ï¼‰ï¼š</strong><br>`;
            nonMonthlyDates.forEach(date => {
                const span = document.createElement('span');
                span.className = 'clickable-date';
                span.textContent = date;
                span.onclick = () => { if (confirm(`æ˜¯å¦å°‡æ—¥æœŸ ${date} åŠ å…¥æœˆçµç´¯è¨ˆä¸­ï¼Ÿ`)) { forceIncludeDates.add(date); render(); } };
                el.appendChild(span);
            });
        } else el.style.display = 'none';
    }

    document.getElementById('personSelect').addEventListener('change', e => updateDetail(e.target.value));

    document.getElementById('copyBtn').addEventListener('click', () => {
        const name = document.getElementById('personSelect').value;
        const stats = personalStats[name];
        let txt = `ã€${name}${stats.error?'*':''} æ˜ç´°ã€‘\n` + stats.details.map(d=>`${d.date} ${d.text} (${d.price})`).join('\n') + `\n---\nç¸½è¨ˆï¼š${stats.total}`;
        navigator.clipboard.writeText(txt).then(()=>alert('æ–‡å­—å·²è¤‡è£½'));
    });

    document.getElementById('copyImgBtn').addEventListener('click', () => {
        const area = document.getElementById('captureArea');
        const imgTitle = document.getElementById('imgTitle');
        
        imgTitle.style.display = 'block';
        document.body.classList.add('capturing');
        
        setTimeout(() => {
            html2canvas(area, { 
                scale: 2, 
                backgroundColor: "#ffffff"
            }).then(canvas => {
                canvas.toBlob(blob => {
                    navigator.clipboard.write([new ClipboardItem({"image/png": blob})]).then(()=> {
                        alert('åœ–ç‰‡å·²è¤‡è£½ï¼æ•¸å­—ç¾åœ¨é¡¯ç¤ºç‚ºæ¸…æ™°æ–‡å­—ã€‚');
                        imgTitle.style.display = 'none';
                        document.body.classList.remove('capturing');
                    });
                });
            });
        }, 150);
    });
</script>
</body>
</html>